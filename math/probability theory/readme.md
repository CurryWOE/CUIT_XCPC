#! https://zhuanlan.zhihu.com/p/656547289
# 概率论
当概率论和DP复合时，问题转化为图上问题，状态看成点，状态转移看成边

如果该问题无后效性，那么按照拓扑序DP，否则高斯消元

如果纯概率论题，套公式即可
## 随机变量
定义：值无法预先确定，仅以一定可能性取值的量

按照取值数量是否有限分为“离散型”和“连续型”

另有两篇文章介绍XCPC中可能用到的“离散型”相关知识和“连续型”相关知识
# 概率DP
根据全概率公式，设点 $v$ 的入边的另一个点 $u$
$$P(v)=\sum P(u)P(v|u)$$
# 期望DP
$P(X)，E(X)$ 通常有两种定义

1. 起点到 $X$ 的概率，期望
2. $X$ 到终点的概率，期望

第二种用的比较多，因为第二种定义的概率常常为 1，方便编写

如果有自环，需要移项使得两边没有同样的式子

第二种需要建反图跑DP

第1种定义（统计入边）
$$E(Y)=\sum [E(X)+W(X\rightarrow Y)P(X)]P(Y|X)$$

第2种定义（统计出边）
$$E(Y)=\sum [E(X)+W(Y\rightarrow X)P(Y)]P(X|Y)$$
## 第一种定义期望公式的证明
>第二种类似

设 $x_i$ 为起点到 $X$ 的入边的另一个点 $Y$ 的路径长度，$p_i$ 为走该路径的概率

有一条 $Y$ 到 $X$ 的边,边权为 $w_j$

定义得
$$E(Y)=\sum x_ip_i$$
$$E(X)=\sum (x_i+w_j)p_iP(X|Y)$$
$P(X|Y)$ 提到前面去，$p_i$ 乘法分配律
$$E(X)=P(X|Y)\sum x_ip_i+w_jp_i$$
求和号可以拆成两个，前面一个就是 $E(Y)$，$w_j$ 提到前面去
$$E(X)=P(X|Y)[E(Y)+w_j\sum p_i]$$
显然后面一个就是 $P(Y)$
$$E(X)=P(X|Y)[E(Y)+w_jP(Y)]$$
# 例题讲解
## 前缀和技巧
$P(X=k)=P(X\le k)-P(X\le k-1)$
## 取球游戏
箱子里有 $n$ 个球 $1 \cdots n$，你要从里面拿 $m$ 次球，求取出的数字之和的期望。

1. 取出后放回
2. 取出后不放回
3. 取出后有 $p$ 的几率放回，有 $1-p$ 的几率放回两个

无论是哪种情况，因为过程中所有的球都是等价的，答案都是 $\frac{m(n+1)}2$
## 游走问题(马尔可夫过程)
在图上随机移动，从A点到B点的期望步数
### 链(一端到另一端)
设 $f_i$ 表示 $i$ 第一次游走到 $i+1$ 的期望步数，显然 $f_1 = 1$

考虑在 $i$ 点的可行策略可以得到转移 $f_{i} = \frac{1}{2}* 1 + \frac{1}{2}(1+f_{i-1}+f_{i})$

略加整理可得 $f_{i} = 2+f_{i-1}$

有 $f_n = (n-1)^2$
### 完全图
显然从任意一个点到任意一个点的期望步数是相同的，概率也是相同的

考虑每次到达指定点是一个概率为 $\frac{1}{n-1}$ 的事件，期望就是 $n-1$
### 完全二分图
类似于完全图，这里每一边的点概率均等

我们设 $E_1,E_2$ 分别表示从同侧点到达目标点的代价和异侧点到目标点的代价

转移有 $E_1 = \frac{1}{2} + \frac{1}{2}(1+E_2)$，$E_2 = 1+E_1$

可以得到 $E_2 = 2n-1$，$E_1 = 2n$
### 菊花图
菊花图上每个叶到叶，根到叶，叶到根的期望都是相同的

并且考虑叶之间并没有任何不同 但是在根和叶之间是区分出题目给出的起点和终点的

所以设 $E_1$ 表示根到叶的期望， $E_2$ 表示叶到叶的期望，显然叶到根点的期望为 $1$

所以可以得到 $E_1 = \frac{1}{n-1}+\frac{n-2}{n-1}(1+E_2)$,$E_2 = 1+E_1$

可以得到 $E_1 = 2n-3,E_2 = 2n-2$
### 树(根为起点)
考虑树形 dp。设 $x$ 为 $i$ 的父亲，$d[v]$ 表示点 $v$ 的度数，$son[v]$ 表示 $v$ 的孩子集合

设 $f_i$ 表示 $i$ 走到它父亲的期望步数，$g_i$ 表示 $i$ 的父亲走到 $i$ 的期望步数。可以写出 $f$ 的转移：

$$f_{i} = \frac{1+(\sum_{v \in son[i]}1+f_v+f_i)}{d_i}$$

化简可得：

$$f_{i} = d[i]+\sum_{v \in son_i} f_v$$

同样的可以写出 $g$ 的转移：

$$g_i = frac{1+(1+g_x+g_i)+(sum_{v in son_x且v neq i}1+f_v+g_i)}{d[x]}$$

化简可得：

$$g_i = g_x+d[x]+\sum_{v \in son_x且v \neq i}f_v$$
### 构造一个图
构造一张200个点的无向图，使得上面从S走到T的随机游走期望步数 $\ge 1e6$

我们构造一个n=100个点的团，以及一个 100 个点的链，考虑他们的连接点u，则u沿着链走一步的期望步数为

$\begin{aligned}E(u)&=\frac 1n+\frac{n-1}n(n-1+E(u))\\&=1+(n-1)^2\end{aligned}$

而我们知道在链上走的期望，于是得到走到终点的总期望为

$\frac{(E(u)+E(u)+2n)(n+1)}2$
​
可以达到要求
## 贡献拆分
>其实很多题，不止概率论，用得到这个技巧

第 $i$ 个人的排名，等价于 $\sum\limits_{j=1,j\ne i}^n[rk_j<rk_i]$
### 例题1
有 $n$ 堆石头，第 $i$ 堆个数为 $a_i$。每次随机选一个石头然后把那一整堆都扔了，求第1堆石头期望第几次被扔
### 例题2
给1,2,⋯,n这n个数，每次随机选择一个还在的数，删掉他的所有约数。求期望几次删完
### 例题3
给出一棵树, 一开始每个点都是白的, 每次选一个白点将他子树里所有点染黑，求期望几次染黑整个树
